<!DOCTYPE html>
<html>
  <head>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <link href='main.css' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="youtube.js"></script>
  <script type="text/javascript">
    var list;
    var repeat_all = false;
    var repeat_one = false;
    var currently_playing = false;
    var sbar;
    var search_res;

    function getVidRow(id,snippet, func){
        var li = document.createElement('tr');
        li.id=id;
        li.core_snippet = snippet;
        var titleTd=document.createElement('td');
        var thumbTd=document.createElement('td');
        var buttonTd=document.createElement('td');

        var title = document.createElement('h3'); titleTd.appendChild(title);
        var thumb= document.createElement('img'); thumbTd.appendChild(thumb);
        var button = document.createElement('button'); buttonTd.appendChild(button);

        li.appendChild(thumbTd);li.appendChild(titleTd);li.appendChild(buttonTd);

        title.id='title';
        thumb.id='thumb';
        button.id='button';

        if(func=='add'){
            button.className='fab'
            button.innerHTML='<i class="material-icons">add</i>'
            button.id=id;
            button.tag=snippet
            button.onclick=function(){addToPlaylist(this.id, this.tag)}
        } else if(func=='remove'){
            button.className='fab'
            button.innerHTML='<i class="material-icons">clear</i>'
            button.id=id;
            button.onclick=function() {
                list.removeChild(document.getElementById(this.id));
                savePlaylist();
            }
        }

        title.innerHTML = snippet.title;
        thumb.src = snippet.thumbnails.default.url;

        return li;
    }

    function playNext() {
        player.stopVideo()

        //loop = document.getElementById("looper").checked;
        //repeat_current = document.getElementById("repeat_indefinitely").checked;

        if(repeat_one && currently_playing){
            player.seekTo(0);
            player.playVideo();
        }

        else if(list.hasChildNodes()) {
            if(repeat_all && !repeat_one && currently_playing)
                list.appendChild(currently_playing);

            var next_song = list.childNodes[0];
            currently_playing = next_song;
            list.removeChild(next_song);
            player.loadVideoById(next_song.id);
        }

        else
            playing=false;

        savePlaylist();
    }

    function addToPlaylist(id,snippet){
        var li=getVidRow(id,snippet,'remove');
        list.appendChild(li);

        if(!playing)
            playNext();

        savePlaylist();
    }

    function savePlaylist() {
        var list_of_nodes = [];
        var length = list.childNodes.length;
        var i;
        if(currently_playing)
            list_of_nodes.push([currently_playing.id, currently_playing.core_snippet]);
        for(i=0;i<length;i++)
            list_of_nodes.push([list.childNodes[i].id, list.childNodes[i].core_snippet]);
        localStorage.setItem('playlist', JSON.stringify(list_of_nodes));
        localStorage.setItem('playlist_saved', JSON.stringify(true));
    }

    function loadPlaylist() {
        if(JSON.parse(localStorage.getItem('playlist_saved'))) {
            var list_of_nodes = JSON.parse(localStorage.getItem('playlist'));
            var length = list_of_nodes.length;
            var i;
            for(i=0; i < length; i++) {
                id = list_of_nodes[i][0];
                snippet = list_of_nodes[i][1];
                var li = getVidRow(id, snippet, 'remove');
                list.appendChild(li);
            }
        }
    }


    function search(params){
        search_res.innerHTML='';

        if(params.length>0){
            YouTube.search.list({
                q:params,
                part:'snippet',
                type:'video',
                videoEmbeddable:'true'
            }).execute(function(response){
                for(var i=0; i<response.items.length; i++){
                    var item = response.items[i]
                    var li = getVidRow(item.id.videoId, item.snippet,'add');
                    search_res.appendChild(li);
                }
            });
        }
    }

    function toggle(btn){
        if(btn.id=='repeat_all'){
            if(btn.className=='active'){
                repeat_all=false;
                btn.className='';
            } else {
                repeat_all=true;
                btn.className='active';
            }

            document.getElementById("repeat_one").className="";
            repeat_one=false;
        } else if(btn.id=='repeat_one'){
            if(btn.className=='active'){
                repeat_one=false;
                btn.className='';
            } else {
                repeat_one=true;
                btn.className='active';
            }

            document.getElementById("repeat_all").className="";
            repeat_all=false;
        }
    }
  </script>
  </head>
  <body onload="loadPlaylist()">
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="left" style="margin-left:13%;margin-right:4%;width:33%;display:inline-block;vertical-align:top">
        <center><div id="player"></div>
        <br>
        <button onclick="playNext()" style="width:100%">Next</button><br>
        <button title="Courtesy of Sayantan Khan (Bolt64)" id="repeat_all" onclick="toggle(this)" style="width:48%">Repeat All</button>
        <button title="Courtesy of Sayantan Khan (Bolt64)" id="repeat_one" onclick="toggle(this)" style="width:48%">Repeat One</button>
        </center>
        <h3>Next in line :</h3>
        <table id="list" style="width:100%"></table>
    </div>
    <div id="right" style="margin-right:13%;width:33%;display:inline-block;vertical-align:top">
        <input type="text" id="sbar"/>
        <button onclick="search(document.getElementById('sbar').value)">Search</button><br>
        <hr>
        <table id="search_res" style="width:100%"></table>
    </div>

    <script>
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      list=document.getElementById('list');
      search_res=document.getElementById('search_res');
      sbar=document.getElementById('sbar');

      sbar.addEventListener("keydown",function(e){
            if(!e) e=window.event;

            if(e.keyCode==13)
                search(sbar.value)
      });
    </script>
    <script src="https://apis.google.com/js/client.js?onload=onGoogleApiClientLoad"></script>
  </body>
</html>
